<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>Deep Dark Calendar</title>
    <style>
        :root {
            --bg-color: #000000;
            --surface-color: #1c1c1e;
            --surface-light: #2c2c2e;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --accent-color: #0a84ff;
            --danger-color: #ff453a;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --header-height: 50px;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-primary); overflow: hidden; height: 100vh; width: 100vw; }
        input, textarea { font-family: inherit; }
        .hidden { display: none !important; }

        /* App Structure */
        #app { position: relative; width: 100%; height: 100%; overflow: hidden; }
        
        /* Header */
        header {
            position: absolute; top: 0; left: 0; right: 0; height: calc(var(--header-height) + var(--safe-top));
            padding-top: var(--safe-top); display: flex; justify-content: space-between; align-items: center;
            padding-left: 16px; padding-right: 16px; z-index: 100; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid rgba(255,255,255,0.1);
        }
        .nav-title { font-weight: 600; font-size: 1.1rem; }
        .nav-btn { color: var(--accent-color); font-size: 1.2rem; padding: 10px; cursor: pointer; min-width: 40px; display: flex; align-items: center; justify-content: center; }

        /* View Container */
        .view-container { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            padding-top: calc(var(--header-height) + var(--safe-top));
            background: var(--bg-color); overflow: hidden;
        }

        /* Month View */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); padding: 10px; height: 100%; align-content: start; }
        .weekday-row { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; color: var(--text-secondary); font-size: 0.8rem; padding: 10px 10px 5px; }
        .day-cell { height: 12vh; display: flex; flex-direction: column; align-items: center; border-radius: 8px; position: relative; border-top: 0.5px solid rgba(255,255,255,0.05); transition: background 0.2s; }
        .day-cell:active { background: var(--surface-color); }
        .day-cell.today .day-num { background: var(--danger-color); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
        .day-num { margin-top: 6px; font-size: 1rem; font-weight: 500; }
        .dots { display: flex; gap: 3px; margin-top: 4px; }
        .dot { width: 5px; height: 5px; border-radius: 50%; }

        /* Week View (Compressed 24h) */
        .week-view-container { display: flex; height: 100%; width: 100%; flex-direction: column; }
        .week-header-row { display: grid; grid-template-columns: 40px repeat(7, 1fr); text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        .week-body { flex: 1; display: flex; position: relative; overflow: hidden; } /* No scroll */
        .week-time-col { width: 40px; height: 100%; border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; justify-content: space-between; padding-top: 10px; padding-bottom: 10px; }
        .week-time-label { font-size: 0.6rem; color: var(--text-secondary); text-align: right; padding-right: 5px; transform: translateY(-50%); height: 0; }
        .week-grid-col { flex: 1; display: grid; grid-template-columns: repeat(7, 1fr); height: 100%; position: relative; }
        .week-day-column { border-right: 1px solid rgba(255,255,255,0.05); height: 100%; position: relative; }
        .week-event-block { position: absolute; left: 2px; right: 2px; border-radius: 2px; opacity: 0.8; min-height: 2px; }

        /* Day View */
        .week-strip { display: flex; justify-content: space-around; padding: 10px 0; background: var(--bg-color); border-bottom: 0.5px solid rgba(255,255,255,0.1); z-index: 10; position: relative; }
        .strip-day { display: flex; flex-direction: column; align-items: center; padding: 5px 10px; border-radius: 12px; font-size: 0.8rem; color: var(--text-secondary); }
        .strip-day.active { background: var(--surface-color); color: white; }
        .strip-day span:first-child { font-size: 0.7rem; margin-bottom: 2px; }
        .strip-day span:last-child { font-size: 1.1rem; font-weight: bold; }

        #day-scroll { overflow-y: auto; height: calc(100% - 60px); position: relative; -webkit-overflow-scrolling: touch; }
        .timeline-container { position: relative; width: 100%; height: 1440px; transition: height 0.1s linear; }
        .hour-mark { position: absolute; left: 10px; width: 100%; color: var(--text-secondary); font-size: 0.8rem; border-top: 0.5px solid rgba(255,255,255,0.1); }
        
        .event-block { 
            position: absolute; left: 60px; right: 10px; border-radius: 8px; padding: 8px; 
            overflow: hidden; font-size: 0.9rem; font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; justify-content: center;
        }
        .event-block.reminder-on { border: 2px solid rgba(255,255,255,0.8); box-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .event-actions { position: absolute; right: 10px; top: 0; bottom: 0; display: flex; align-items: center; gap: 10px; transform: translateX(150%); transition: transform 0.3s ease; }
        .event-block.swiped .event-content { transform: translateX(-120px); }
        .event-block.swiped .event-actions { transform: translateX(0); }
        .action-btn { width: 50px; height: 100%; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: bold; color: white; }

        /* Sidebar & Settings */
        .sidebar-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 400; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .sidebar { 
            position: fixed; top: 0; left: 0; width: 80%; height: 100%; background: var(--surface-color); 
            z-index: 500; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            padding-top: calc(var(--safe-top) + 20px); overflow: hidden;
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-backdrop.open { opacity: 1; pointer-events: auto; }
        
        .settings-page { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--surface-color); padding: 20px; 
            padding-top: calc(var(--safe-top) + 60px);
            transition: transform 0.3s ease; 
        }
        #settings-root { transform: translateX(0); z-index: 500; }
        .sub-page { transform: translateX(100%); z-index: 501; }
        .sub-page.active { transform: translateX(0); }
        
        .list-item { background: var(--surface-light); padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .setting-header { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; color: white; padding-left: 10px; }

        /* Modal */
        .modal { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 92%; background: var(--surface-color); 
            border-radius: 20px 20px 0 0; z-index: 600; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
        }
        .modal.open { transform: translateY(0); }
        .modal-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid rgba(255,255,255,0.1); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 0.9rem; }
        .form-input { width: 100%; background: var(--surface-light); border: none; padding: 12px; border-radius: 10px; color: white; font-size: 1.1rem; }
        .row-btn { display: flex; justify-content: space-between; align-items: center; background: var(--surface-light); padding: 12px; border-radius: 10px; margin-bottom: 10px; }
        .color-dot-select { width: 36px; height: 36px; border-radius: 50%; border: 3px solid transparent; transition: transform 0.2s; }
        .color-dot-select.selected { border-color: white; transform: scale(1.1); }

        /* Clock Picker */
        .clock-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 700; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .clock-overlay.open { opacity: 1; pointer-events: auto; }
        .clock-face { width: 280px; height: 280px; background: var(--surface-light); border-radius: 50%; position: relative; margin: 20px; }
        .clock-num { 
            position: absolute; width: 40px; height: 40px; text-align: center; line-height: 40px; 
            color: white; transform: translate(-50%, -50%); z-index: 2; pointer-events: none; border-radius: 50%;
            transition: background 0.1s, color 0.1s;
        }
        .clock-num.active { background: var(--accent-color); color: white; font-weight: bold; }
        .clock-hand { 
            position: absolute; top: 50%; left: 50%; width: 2px; height: 110px; background: var(--accent-color); 
            transform-origin: bottom center; transform: translate(-50%, -100%) rotate(0deg); pointer-events: none;
        }
        .clock-hand::after {
            content: ''; position: absolute; top: -15px; left: -14px; width: 30px; height: 30px; 
            border-radius: 50%; border: 2px solid var(--accent-color); background: transparent;
        }
        .clock-center-display {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 1.5rem; font-weight: bold; color: var(--accent-color); z-index: 0; opacity: 0.3;
        }

        /* AI Suggestions */
        .ai-result-panel { 
            background: var(--surface-light); padding: 15px; border-radius: 12px; margin-top: 15px; 
            animation: fadeIn 0.3s ease; border: 1px solid var(--accent-color);
        }
        .ai-suggestion-item { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
        .ai-suggestion-item:last-child { border-bottom: none; }
        .ai-tag { display: inline-block; background: var(--accent-color); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Buttons */
        .btn-done { color: var(--accent-color); font-weight: 600; font-size: 1.1rem; }
        .btn-cancel { color: var(--danger-color); font-size: 1.1rem; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div class="nav-btn" id="nav-left">☰</div>
        <div class="nav-title" id="nav-title">Calendar</div>
        <div class="nav-btn" id="nav-right">›</div>
    </header>

    <div id="view-container" class="view-container"></div>

    <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
    <div class="sidebar" id="sidebar">
        <div class="settings-page" id="settings-root">
            <div class="setting-header" data-t="settings">Settings</div>
            <div class="list-item" onclick="Settings.nav('lang')">
                <span data-t="lang">Language</span> <span>›</span>
            </div>
            <div class="list-item" onclick="Settings.nav('sound')">
                <span data-t="ringtone">Ringtone</span> <span>›</span>
            </div>
        </div>

        <div class="settings-page sub-page" id="settings-lang">
            <div class="nav-btn" onclick="Settings.back()" style="margin-bottom:20px; display:block;">← <span data-t="back">Back</span></div>
            <div class="setting-header" data-t="lang">Language</div>
            <div class="list-item" onclick="Settings.setLang('en')">English</div>
            <div class="list-item" onclick="Settings.setLang('zh')">繁體中文</div>
        </div>

        <div class="settings-page sub-page" id="settings-sound">
            <div class="nav-btn" onclick="Settings.back()" style="margin-bottom:20px; display:block;">← <span data-t="back">Back</span></div>
            <div class="setting-header" data-t="ringtone">Ringtone</div>
            <div style="padding: 20px 0;">
                <label class="form-label">Volume</label>
                <input type="range" id="vol-slider" min="0" max="1" step="0.1" style="width:100%">
            </div>
            <div class="list-item" onclick="Settings.setTone('Beep')">Beep</div>
            <div class="list-item" onclick="Settings.setTone('Chime')">Chime</div>
        </div>
    </div>

    <div class="modal" id="event-modal">
        <div class="modal-header">
            <span class="btn-cancel" onclick="Modal.close()" data-t="cancel">Cancel</span>
            <span style="font-weight:600" data-t="event">Event</span>
            <span class="btn-done" onclick="Modal.save()" data-t="done">Done</span>
        </div>
        <div class="modal-body">
            <input type="text" id="evt-title" class="form-input" placeholder="Title" style="font-size:1.5rem; font-weight:bold; margin-bottom:20px;">
            
            <div class="row-btn" onclick="ClockPicker.open('start')">
                <span data-t="startTime">Start Time</span>
                <span id="display-start" style="color:var(--accent-color)">12:00</span>
            </div>
            <div class="row-btn" onclick="ClockPicker.open('end')">
                <span data-t="endTime">End Time</span>
                <span id="display-end" style="color:var(--accent-color)">13:00</span>
            </div>

            <div class="row-btn">
                <span data-t="repeat">Repeat Weekly</span>
                <input type="checkbox" id="evt-repeat" style="transform: scale(1.5);">
            </div>
            <div class="row-btn hidden" id="repeat-end-row">
                <span data-t="endDate">End Date</span>
                <input type="date" id="evt-repeat-end" style="background:transparent; color:white; border:none; text-align:right;">
            </div>

            <div class="form-group">
                <label class="form-label" data-t="color">Color</label>
                <div style="display:flex; gap:15px; overflow-x:auto; padding:5px; align-items:center;" id="color-list"></div>
                <input type="color" id="custom-color-picker" style="visibility:hidden; position:absolute;">
            </div>

            <div class="form-group">
                <label class="form-label" data-t="notes">Notes</label>
                <textarea id="evt-desc" class="form-input" rows="2"></textarea>
            </div>

            <button onclick="AI.analyze()" style="width:100%; background: linear-gradient(135deg, #2980b9, #8e44ad); color:white; padding:15px; border-radius:12px; border:none; font-size:1.1rem; font-weight:bold; margin-top:20px; display:flex; justify-content:center; align-items:center; gap:10px;">
                ✨ AI Suggestion
            </button>
            <div id="ai-results" class="hidden"></div>
        </div>
    </div>

    <div class="clock-overlay" id="clock-picker">
        <h2 id="clock-title" style="color:white; margin-bottom:20px;">Select Hour</h2>
        <div class="clock-face" id="clock-face">
            <div class="clock-center-display" id="clock-center-display"></div>
            <div class="clock-hand" id="clock-hand"></div>
        </div>
        <div style="margin-top:30px; display:flex; gap:20px;">
            <button class="btn-cancel" style="background:none; border:none;" onclick="ClockPicker.close()" data-t="cancel">Cancel</button>
            <button class="btn-done" style="background:var(--accent-color); color:white; padding:10px 30px; border-radius:20px; border:none;" onclick="ClockPicker.next()" data-t="next">Next</button>
        </div>
    </div>

</div>

<script type="module">
import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

const API_KEY = "AIzaSyDvWhhjHmRqNOdAUfd0i16qaUL8MaSg0Uc"; 

// --- Translations ---
const Translations = {
    en: {
        calendar: "Calendar", settings: "Settings", lang: "Language", ringtone: "Ringtone", back: "Back",
        event: "Event", done: "Done", cancel: "Cancel", startTime: "Start Time", endTime: "End Time",
        repeat: "Repeat Weekly", endDate: "End Date", color: "Color", notes: "Notes", next: "Next",
        dayView: "Day View", weekView: "Week View", monthView: "Month View"
    },
    zh: {
        calendar: "行事曆", settings: "設定", lang: "語言", ringtone: "鈴聲", back: "返回",
        event: "行程", done: "完成", cancel: "取消", startTime: "開始時間", endTime: "結束時間",
        repeat: "每週重複", endDate: "結束日期", color: "顏色", notes: "備註", next: "下一步",
        dayView: "本日行程", weekView: "週檢視", monthView: "月曆"
    }
};

// --- Store ---
const Store = {
    data: {
        events: [],
        settings: { lang: 'zh', tone: 'Beep', vol: 0.8 },
        colors: ['#0a84ff', '#ff3b30', '#30d158', '#bf5af2', '#ff9f0a']
    },
    init() { try { const d = localStorage.getItem('dark-cal-db'); if(d) this.data = JSON.parse(d); } catch(e){} },
    save() { localStorage.setItem('dark-cal-db', JSON.stringify(this.data)); },
    getEvents(date) {
        const dStr = date.toDateString();
        const dayTime = date.getTime();
        return this.data.events.filter(e => {
            if(!e.repeat && new Date(e.start).toDateString() === dStr) return true;
            if(e.repeat) {
                const start = new Date(e.start);
                const isSameDay = start.getDay() === date.getDay();
                const afterStart = dayTime >= start.setHours(0,0,0,0);
                let beforeEnd = true;
                if(e.repeatEnd) beforeEnd = dayTime <= new Date(e.repeatEnd).getTime();
                return isSameDay && afterStart && beforeEnd;
            }
            return false;
        });
    }
};

const Utils = {
    pad(n) { return n < 10 ? '0'+n : n; },
    formatTime(d) { return `${this.pad(d.getHours())}:${this.pad(d.getMinutes())}`; },
    t(key) { return Translations[Store.data.settings.lang][key] || key; }
};

// --- App State ---
const App = {
    view: 'month',
    date: new Date(),
    zoom: 60,
    
    init() {
        Store.init();
        this.updateLang(); // Apply translations
        this.render();
        this.bindGlobal();
    },

    bindGlobal() {
        document.getElementById('nav-left').onclick = () => this.nav('left');
        document.getElementById('nav-right').onclick = () => this.nav('next');
        document.getElementById('sidebar-backdrop').onclick = () => Settings.close();
        document.getElementById('evt-repeat').onchange = (e) => {
            document.getElementById('repeat-end-row').classList.toggle('hidden', !e.target.checked);
        };
        document.getElementById('custom-color-picker').onchange = (e) => {
            const color = e.target.value;
            Store.data.colors.push(color);
            Store.save();
            Modal.renderColors();
            Modal.selectedColor = color;
            Modal.updateColorUI();
        };

        // Swipe Edge for Sidebar
        let startX = 0;
        document.addEventListener('touchstart', e => startX = e.touches[0].clientX);
        document.addEventListener('touchmove', e => {
            const diff = e.touches[0].clientX - startX;
            if(this.view === 'month' && startX < 30 && diff > 50) Settings.open();
        });
    },

    updateLang() {
        document.querySelectorAll('[data-t]').forEach(el => {
            el.innerText = Utils.t(el.getAttribute('data-t'));
        });
        document.getElementById('evt-title').placeholder = Utils.t('event');
    },

    nav(action) {
        if(action === 'left') {
            if(this.view === 'month') Settings.open();
            else if(this.view === 'day') this.setView('week'); // Day -> Week
            else if(this.view === 'week') this.setView('month'); // Week -> Month
        } else if (action === 'next') this.moveDate(1);
    },

    moveDate(dir) {
        if(this.view === 'month') this.date.setMonth(this.date.getMonth() + dir);
        else if(this.view === 'week') this.date.setDate(this.date.getDate() + (dir*7));
        else this.date.setDate(this.date.getDate() + dir);
        this.render();
    },

    setView(v, d) {
        if(d) this.date = new Date(d);
        this.view = v;
        this.render();
    },

    render() {
        const container = document.getElementById('view-container');
        container.innerHTML = '';
        
        const titleEl = document.getElementById('nav-title');
        const leftEl = document.getElementById('nav-left');
        const nextEl = document.getElementById('nav-right');

        // Dynamic Header
        if(this.view === 'month') {
            titleEl.innerText = this.date.toLocaleDateString(Store.data.settings.lang === 'en' ? 'en-US' : 'zh-TW', { year: 'numeric', month: 'long' });
            leftEl.innerText = '☰';
            nextEl.innerText = '›';
            this.renderMonth(container);
        } else if (this.view === 'week') {
            titleEl.innerText = Utils.t('weekView');
            leftEl.innerText = '←';
            nextEl.innerText = '›';
            this.renderWeek(container);
        } else {
            titleEl.innerText = Utils.t('dayView');
            leftEl.innerText = '←';
            nextEl.innerText = '›';
            this.renderDay(container);
        }
    },

    renderMonth(container) {
        const grid = document.createElement('div');
        grid.className = 'calendar-grid';
        
        // Header
        const daysHeader = document.createElement('div');
        daysHeader.className = 'weekday-row';
        ['S','M','T','W','T','F','S'].forEach(d => daysHeader.innerHTML += `<div>${d}</div>`);
        container.appendChild(daysHeader);

        const y = this.date.getFullYear(), m = this.date.getMonth();
        const first = new Date(y, m, 1).getDay();
        const total = new Date(y, m+1, 0).getDate();

        for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
        for(let i=1; i<=total; i++) {
            const el = document.createElement('div');
            el.className = 'day-cell';
            if(i === new Date().getDate() && m === new Date().getMonth()) el.classList.add('today');
            el.innerHTML = `<div class="day-num">${i}</div><div class="dots"></div>`;
            const evts = Store.getEvents(new Date(y, m, i));
            evts.slice(0,3).forEach(e => {
                const d = document.createElement('div'); d.className='dot'; d.style.background = e.color;
                el.querySelector('.dots').appendChild(d);
            });
            el.onclick = () => this.setView('week', new Date(y, m, i)); // Click day -> Week
            grid.appendChild(el);
        }
        container.appendChild(grid);
    },

    renderWeek(container) {
        const wrapper = document.createElement('div');
        wrapper.className = 'week-view-container';

        // Header Row (Dates)
        const header = document.createElement('div');
        header.className = 'week-header-row';
        header.innerHTML = '<div></div>'; // Spacer for time
        const start = new Date(this.date);
        start.setDate(start.getDate() - start.getDay()); // Start Sunday
        const daysMap = ['S','M','T','W','T','F','S'];

        for(let i=0; i<7; i++) {
            const d = new Date(start); d.setDate(d.getDate() + i);
            const isToday = d.toDateString() === new Date().toDateString();
            header.innerHTML += `<div style="display:flex; flex-direction:column; align-items:center; ${isToday?'color:var(--danger-color);':''}">
                <span style="font-size:0.7rem">${daysMap[i]}</span>
                <span style="font-size:1.1rem; font-weight:bold">${d.getDate()}</span>
            </div>`;
        }
        wrapper.appendChild(header);

        // Body (Compressed 24h)
        const body = document.createElement('div');
        body.className = 'week-body';
        
        // Time Col
        const timeCol = document.createElement('div');
        timeCol.className = 'week-time-col';
        for(let i=0; i<=24; i+=3) { // Show every 3 hours to save space
            timeCol.innerHTML += `<div class="week-time-label" style="top:${(i/24)*100}%">${i}:00</div>`;
        }
        body.appendChild(timeCol);

        // Grid Cols
        const gridCol = document.createElement('div');
        gridCol.className = 'week-grid-col';
        
        for(let i=0; i<7; i++) {
            const d = new Date(start); d.setDate(d.getDate() + i);
            const dayCol = document.createElement('div');
            dayCol.className = 'week-day-column';
            dayCol.onclick = () => this.setView('day', d); // Click col -> Day

            const evts = Store.getEvents(d);
            evts.forEach(e => {
                const s = new Date(e.repeat ? d : e.start);
                const hrs = new Date(e.start).getHours();
                const mins = new Date(e.start).getMinutes();
                const durH = (new Date(e.end) - new Date(e.start)) / 3600000;
                
                const top = ((hrs + mins/60) / 24) * 100;
                const height = (durH / 24) * 100;
                
                const blk = document.createElement('div');
                blk.className = 'week-event-block';
                blk.style.top = top + '%';
                blk.style.height = height + '%';
                blk.style.background = e.color;
                dayCol.appendChild(blk);
            });
            gridCol.appendChild(dayCol);
        }
        body.appendChild(gridCol);
        wrapper.appendChild(body);
        container.appendChild(wrapper);
    },

    renderDay(container) {
        // Week Strip (Top)
        const strip = document.createElement('div');
        strip.className = 'week-strip';
        const start = new Date(this.date);
        start.setDate(start.getDate() - start.getDay());
        const daysMap = ['S','M','T','W','T','F','S'];
        
        for(let i=0; i<7; i++) {
            const d = new Date(start); d.setDate(d.getDate() + i);
            const el = document.createElement('div');
            el.className = `strip-day ${d.getDate() === this.date.getDate() ? 'active' : ''}`;
            el.innerHTML = `<span>${daysMap[i]}</span><span>${d.getDate()}</span>`;
            el.onclick = () => { this.date = d; this.render(); };
            strip.appendChild(el);
        }
        container.appendChild(strip);

        // Scrollable Timeline
        const scroll = document.createElement('div');
        scroll.id = 'day-scroll';
        const timeline = document.createElement('div');
        timeline.className = 'timeline-container';
        timeline.style.height = (this.zoom * 24) + 'px';
        
        for(let i=0; i<24; i++) {
            const mk = document.createElement('div');
            mk.className = 'hour-mark';
            mk.style.top = (i * this.zoom) + 'px';
            mk.innerText = i + ':00';
            timeline.appendChild(mk);
        }

        const events = Store.getEvents(this.date);
        events.forEach(e => {
            const s = new Date(e.repeat ? this.date : e.start);
            const realStart = new Date(e.start);
            s.setHours(realStart.getHours(), realStart.getMinutes());
            const end = new Date(s);
            const realEnd = new Date(e.end);
            end.setHours(realEnd.getHours(), realEnd.getMinutes());

            const top = (s.getHours() + s.getMinutes()/60) * this.zoom;
            const height = Math.max(((end - s) / 3600000) * this.zoom, 30);

            const el = document.createElement('div');
            el.className = `event-block ${e.reminder ? 'reminder-on' : ''}`;
            el.style.top = top + 'px';
            el.style.height = height + 'px';
            el.style.background = e.color;
            el.innerHTML = `
                <div class="event-content">
                    <div>${e.title}</div>
                    <div style="font-size:0.75rem; opacity:0.8">${Utils.formatTime(s)} - ${Utils.formatTime(end)}</div>
                </div>
                <div class="event-actions">
                    <div class="action-btn" style="background:#ff9f0a" onclick="Modal.open('${e.id}')">Edit</div>
                    <div class="action-btn" style="background:#ff453a" onclick="Modal.delete('${e.id}')">Del</div>
                </div>
            `;

            let ts = 0;
            el.addEventListener('touchstart', ev => {
                ts = ev.touches[0].clientX;
                this.lpTimer = setTimeout(() => {
                    e.reminder = !e.reminder;
                    Store.save();
                    this.render();
                    if(navigator.vibrate) navigator.vibrate(200);
                }, 1000);
            });
            el.addEventListener('touchend', ev => {
                clearTimeout(this.lpTimer);
                if(ts - ev.changedTouches[0].clientX > 50) el.classList.add('swiped');
                else el.classList.remove('swiped');
            });
            timeline.appendChild(el);
        });

        timeline.onclick = (e) => {
            if(e.target === timeline) {
                const rect = timeline.getBoundingClientRect();
                const h = Math.floor((e.clientY - rect.top) / this.zoom);
                Modal.open(null, h);
            }
        };

        let initDist = 0, initZoom = 60;
        timeline.addEventListener('touchstart', e => {
            if(e.touches.length === 2) {
                initDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                initZoom = this.zoom;
            }
        });
        timeline.addEventListener('touchmove', e => {
            if(e.touches.length === 2) {
                const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                this.zoom = Math.max(30, Math.min(120, initZoom * (dist/initDist)));
                timeline.style.height = (this.zoom * 24) + 'px';
                this.render();
            }
        });

        scroll.appendChild(timeline);
        container.appendChild(scroll);
    }
};

// --- Modal Logic ---
const Modal = {
    currentId: null,
    startH: 0, startM: 0, endH: 0, endM: 0,
    selectedColor: '',
    
    open(id, hour) {
        document.getElementById('event-modal').classList.add('open');
        document.getElementById('ai-results').innerHTML = '';
        document.getElementById('ai-results').classList.add('hidden');
        
        if(id) {
            this.currentId = id;
            const evt = Store.data.events.find(e => e.id === id);
            document.getElementById('evt-title').value = evt.title;
            document.getElementById('evt-desc').value = evt.desc || '';
            document.getElementById('evt-repeat').checked = evt.repeat;
            document.getElementById('evt-repeat-end').value = evt.repeatEnd || '';
            document.getElementById('repeat-end-row').classList.toggle('hidden', !evt.repeat);
            
            const s = new Date(evt.start);
            const e = new Date(evt.end);
            this.setTime('start', s.getHours(), s.getMinutes());
            this.setTime('end', e.getHours(), e.getMinutes());
            this.selectedColor = evt.color;
        } else {
            this.currentId = null;
            document.getElementById('evt-title').value = '';
            document.getElementById('evt-desc').value = '';
            document.getElementById('evt-repeat').checked = false;
            document.getElementById('evt-repeat-end').value = '';
            document.getElementById('repeat-end-row').classList.add('hidden');
            
            this.setTime('start', hour || 12, 0);
            this.setTime('end', (hour || 12) + 1, 0);
            this.selectedColor = Store.data.colors[0];
        }
        this.renderColors();
        this.updateColorUI();
    },

    close() { document.getElementById('event-modal').classList.remove('open'); },
    
    delete(id) {
        Store.data.events = Store.data.events.filter(e => e.id !== id);
        Store.save();
        App.render();
    },

    save() {
        const title = document.getElementById('evt-title').value || Utils.t('event');
        const s = new Date(App.date); s.setHours(this.startH, this.startM);
        const e = new Date(App.date); e.setHours(this.endH, this.endM);
        
        const evt = {
            id: this.currentId || Date.now().toString(),
            title,
            desc: document.getElementById('evt-desc').value,
            start: s.toISOString(),
            end: e.toISOString(),
            color: this.selectedColor,
            repeat: document.getElementById('evt-repeat').checked,
            repeatEnd: document.getElementById('evt-repeat-end').value,
            reminder: false
        };

        if(this.currentId) {
            const idx = Store.data.events.findIndex(x => x.id === this.currentId);
            Store.data.events[idx] = evt;
        } else {
            Store.data.events.push(evt);
        }
        Store.save();
        this.close();
        App.render();
    },

    setTime(type, h, m) {
        if(type === 'start') { this.startH = h; this.startM = m; }
        else { this.endH = h; this.endM = m; }
        document.getElementById(`display-${type}`).innerText = `${Utils.pad(h)}:${Utils.pad(m)}`;
    },

    renderColors() {
        const cList = document.getElementById('color-list');
        cList.innerHTML = '';
        Store.data.colors.forEach(c => {
            const d = document.createElement('div');
            d.className = 'color-dot-select';
            d.style.background = c;
            d.onclick = () => { this.selectedColor = c; this.updateColorUI(); };
            cList.appendChild(d);
        });
        const add = document.createElement('div');
        add.className = 'color-dot-select';
        add.style.border = '2px dashed gray';
        add.innerText = '+';
        add.style.display='flex'; add.style.alignItems='center'; add.style.justifyContent='center';
        add.onclick = () => {
            document.getElementById('custom-color-picker').click();
        };
        cList.appendChild(add);
    },

    updateColorUI() {
        Array.from(document.getElementsByClassName('color-dot-select')).forEach(el => {
            el.classList.toggle('selected', el.style.backgroundColor === this.selectedColor || el.style.background.includes(this.selectedColor));
        });
    }
};

// --- Clock Picker ---
const ClockPicker = {
    mode: 'hour', target: 'start', valH: 0, valM: 0,
    open(target) {
        this.target = target;
        this.mode = 'hour';
        this.renderFace();
        document.getElementById('clock-picker').classList.add('open');
    },
    close() { document.getElementById('clock-picker').classList.remove('open'); },
    next() {
        if(this.mode === 'hour') { this.mode = 'minute'; this.renderFace(); }
        else { Modal.setTime(this.target, this.valH, this.valM); this.close(); }
    },
    renderFace() {
        const face = document.getElementById('clock-face');
        const display = document.getElementById('clock-center-display');
        document.getElementById('clock-title').innerText = this.mode === 'hour' ? 'Select Hour' : 'Select Minute';
        face.querySelectorAll('.clock-num').forEach(e => e.remove());
        const radius = 110;
        for(let i=1; i<=12; i++) {
            const num = document.createElement('div');
            num.className = 'clock-num';
            num.id = 'clock-num-' + i; // ID for highlight
            const val = this.mode === 'hour' ? i : i*5;
            const showVal = (this.mode === 'minute' && val === 60) ? 0 : val;
            const angle = (i * 30) - 90;
            const rad = angle * (Math.PI / 180);
            num.style.left = (140 + radius * Math.cos(rad)) + 'px';
            num.style.top = (140 + radius * Math.sin(rad)) + 'px';
            num.innerText = showVal;
            face.appendChild(num);
        }
        
        // Initial highlight
        this.highlight(this.mode === 'hour' ? (this.valH || 12) : Math.round((this.valM||0)/5));

        const updateHand = (e) => {
            e.preventDefault();
            const rect = face.getBoundingClientRect();
            const x = e.touches[0].clientX - (rect.left + 140);
            const y = e.touches[0].clientY - (rect.top + 140);
            let deg = Math.atan2(y, x) * (180 / Math.PI) + 90;
            if(deg < 0) deg += 360;
            document.getElementById('clock-hand').style.transform = `translate(-50%, -100%) rotate(${deg}deg)`;
            
            let val;
            if(this.mode === 'hour') {
                val = Math.round(deg / 30); if(val === 0) val = 12; this.valH = val;
                this.highlight(val);
                display.innerText = val;
            } else {
                val = Math.round(deg / 6); if(val === 60) val = 0; this.valM = val;
                this.highlight(Math.round(val/5) === 0 ? 12 : Math.round(val/5)); // Approx highlight for 5-min steps
                display.innerText = Utils.pad(val);
            }
        };
        face.ontouchmove = updateHand; face.ontouchend = updateHand;
    },
    highlight(idx) {
        if(idx===0) idx=12;
        document.querySelectorAll('.clock-num').forEach(e => e.classList.remove('active'));
        const target = document.getElementById('clock-num-'+idx);
        if(target) target.classList.add('active');
    }
};

// --- Settings ---
const Settings = {
    open() { 
        document.getElementById('sidebar').classList.add('open'); 
        document.getElementById('sidebar-backdrop').classList.add('open'); 
        this.reset();
    },
    close() { 
        document.getElementById('sidebar').classList.remove('open'); 
        document.getElementById('sidebar-backdrop').classList.remove('open'); 
    },
    reset() { document.querySelectorAll('.sub-page').forEach(e => e.classList.remove('active')); },
    nav(page) { document.getElementById('settings-'+page).classList.add('active'); },
    back() { this.reset(); },
    setLang(l) { 
        Store.data.settings.lang = l; 
        Store.save(); 
        App.updateLang(); 
        App.render();
    },
    setTone(t) { Store.data.settings.tone = t; Store.save(); }
};

// --- AI Logic (Omitted for brevity, same as previous) ---
const AI = {
    async analyze() {
        const title = document.getElementById('evt-title').value;
        const panel = document.getElementById('ai-results');
        panel.classList.remove('hidden');
        panel.innerHTML = '<div style="color:gray; text-align:center;">Thinking...</div>';
        if(!title) return;
        try {
             // ... (Keep existing logic) ...
            const weekEvents = [];
            const now = new Date(App.date);
            for(let i=0; i<7; i++) {
                const d = new Date(now); d.setDate(d.getDate() + i);
                const evts = Store.getEvents(d);
                evts.forEach(e => weekEvents.push(`${d.toLocaleDateString()}: ${e.title} (${new Date(e.start).getHours()}:${new Date(e.start).getMinutes()} - ${new Date(e.end).getHours()}:${new Date(e.end).getMinutes()})`));
            }
            const context = weekEvents.join('\n');
            const genAI = new GoogleGenerativeAI(API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            const result = await model.generateContent(`
                Role: Calendar Assistant. User wants: "${title}". Schedule: ${context||'None'}.
                Find 3 slots next 7 days. JSON Only: [{ "dayOffset": 0, "startH": 14, "startM": 0, "endH": 15, "endM": 0, "reason": "Free" }]
            `);
            const json = JSON.parse(result.response.text().match(/\[.*\]/s)[0]);
            panel.innerHTML = '';
            json.forEach(slot => {
                const targetDate = new Date(App.date); targetDate.setDate(targetDate.getDate() + slot.dayOffset);
                const item = document.createElement('div'); item.className = 'ai-suggestion-item';
                item.innerHTML = `<span class="ai-tag">${targetDate.toLocaleDateString()}</span> <b>${Utils.pad(slot.startH)}:${Utils.pad(slot.startM)}</b> ${slot.reason}`;
                item.onclick = () => { App.date = targetDate; App.render(); Modal.setTime('start', slot.startH, slot.startM); Modal.setTime('end', slot.endH, slot.endM); panel.classList.add('hidden'); };
                panel.appendChild(item);
            });
        } catch(e) { panel.innerHTML = 'Error'; }
    }
};

window.Settings = Settings; window.Modal = Modal; window.ClockPicker = ClockPicker; window.AI = AI;
App.init();

</script>
</body>
</html>
